{"version":3,"sources":["../src/cli.test.js"],"names":["projectRoot","resolve","__dirname","cliPath","fixturePath","t","stdout","true","test","child","process","env","AWS_KEY_DEV","AWS_SECRET_DEV","BUCKET_NAME_DEV","AWS_REGION_DEV","cwd","stdio","error","fail","all","map","ref","htmlRes","ok","text","revManifestRes","deepEqual","json","is"],"mappings":"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","file":"cli.test.js","sourcesContent":["import test from 'ava';\nimport execa from 'execa';\nimport path from 'path';\nimport fetch from 'node-fetch';\n\nconst projectRoot = path.resolve(__dirname, '..');\nconst cliPath = path.resolve(projectRoot, 'cli.js');\nconst fixturePath = path.resolve(projectRoot, 'fixture');\n\ntest('CLI help works', async (t) => {\n  const stdout = await execa.stdout(cliPath, ['--help']);\n\n  t.true(/All flags are optional/.test(stdout));\n});\n\ntest('CLI deployment works', async (t) => {\n  const child = execa(cliPath, [\n    '--aws-key', process.env.AWS_KEY_DEV,\n    '--aws-secret', process.env.AWS_SECRET_DEV,\n    '--bucket-name', process.env.BUCKET_NAME_DEV,\n    '--aws-region', process.env.AWS_REGION_DEV,\n    '--project-name', 'ft-graphics-deploy/test-fixture',\n    '--branch-name', 'master',\n    '--sha', 'abcdefghijklmnop12345',\n    '--assets-prefix', 'http://example.com/assets/',\n    '--confirm',\n  ], {\n    cwd: fixturePath,\n    stdio: 'inherit',\n  });\n\n  try {\n    await child;\n  } catch (error) {\n    // do not print the error message, as it may contain secrets\n    t.fail('Command exited with non-zero code');\n    return;\n  }\n\n  // check both targets got deployed\n  await Promise.all(['master', 'abcdefghijklmnop12345'].map(async (ref) => {\n    const htmlRes = await fetch(`http://${process.env.BUCKET_NAME_DEV}.s3-website-eu-west-1.amazonaws.com/v2/ft-graphics-deploy/test-fixture/${ref}/`);\n    t.true(htmlRes.ok);\n    t.true(/it works/.test(await htmlRes.text()));\n\n    const revManifestRes = await fetch(`http://${process.env.BUCKET_NAME_DEV}.s3-website-eu-west-1.amazonaws.com/v2/ft-graphics-deploy/test-fixture/${ref}/rev-manifest.json`);\n    t.true(revManifestRes.ok);\n\n    t.deepEqual(await revManifestRes.json(), {\n      'foo.js': 'http://example.com/assets/foo.abc123.js',\n    });\n  }));\n});\n\ntest('CLI preview deployment works', async (t) => {\n  const child = execa(cliPath, [\n    '--aws-key', process.env.AWS_KEY_DEV,\n    '--aws-secret', process.env.AWS_SECRET_DEV,\n    '--bucket-name', process.env.BUCKET_NAME_DEV,\n    '--aws-region', process.env.AWS_REGION_DEV,\n    '--project-name', 'ft-graphics-deploy/test-fixture',\n    '--branch-name', 'master',\n    '--sha', 'abcdefghijklmnop12345',\n    '--assets-prefix', 'http://example.com/assets/',\n    '--preview',\n    '--confirm',\n  ], {\n    cwd: fixturePath,\n    stdio: 'inherit',\n  });\n\n  try {\n    await child;\n  } catch (error) {\n    // do not print the error message, as it may contain secrets\n    t.fail('Command exited with non-zero code');\n    return;\n  }\n\n  // check both targets got deployed\n  await Promise.all(['master', 'abcdefghijklmnop12345'].map(async (ref) => {\n    const htmlRes = await fetch(`http://${process.env.BUCKET_NAME_DEV}.s3-website-eu-west-1.amazonaws.com/v2-preview/ft-graphics-deploy/test-fixture/${ref}/`);\n    t.true(htmlRes.ok);\n    t.true(/it works/.test(await htmlRes.text()));\n\n    const revManifestRes = await fetch(`http://${process.env.BUCKET_NAME_DEV}.s3-website-eu-west-1.amazonaws.com/v2-preview/ft-graphics-deploy/test-fixture/${ref}/rev-manifest.json`);\n    t.true(revManifestRes.ok);\n\n    t.deepEqual(await revManifestRes.json(), {\n      'foo.js': 'http://example.com/assets/foo.abc123.js',\n    });\n  }));\n});\n\ntest('Can get the branch URL', async (t) => {\n  const child = execa(cliPath, [\n    '--aws-key', process.env.AWS_KEY_DEV,\n    '--aws-secret', process.env.AWS_SECRET_DEV,\n    '--bucket-name', process.env.BUCKET_NAME_DEV,\n    '--aws-region', process.env.AWS_REGION_DEV,\n    '--project-name', 'ft-graphics-deploy/test-fixture',\n    '--branch-name', 'master',\n    '--sha', 'abcdefghijklmnop12345',\n    '--assets-prefix', 'http://example.com/assets/',\n    '--get-branch-url',\n  ], { cwd: fixturePath });\n\n  try {\n    await child;\n  } catch (error) {\n    // do not print the error message, as it may contain secrets\n    t.fail('Command exited with non-zero code');\n    return;\n  }\n\n  const { stdout } = await child;\n\n  t.is(stdout, `http://${process.env.BUCKET_NAME_DEV}.s3-website-${process.env.AWS_REGION_DEV}.amazonaws.com/v2/ft-graphics-deploy/test-fixture/master/`);\n});\n\ntest('Can get the commit URL', async (t) => {\n  const child = execa(cliPath, [\n    '--aws-key', process.env.AWS_KEY_DEV,\n    '--aws-secret', process.env.AWS_SECRET_DEV,\n    '--bucket-name', process.env.BUCKET_NAME_DEV,\n    '--aws-region', process.env.AWS_REGION_DEV,\n    '--project-name', 'ft-graphics-deploy/test-fixture',\n    '--branch-name', 'master',\n    '--sha', 'abcdefghijklmnop12345',\n    '--assets-prefix', 'http://example.com/assets/',\n    '--get-commit-url',\n  ], { cwd: fixturePath });\n\n  try {\n    await child;\n  } catch (error) {\n    // do not print the error message, as it may contain secrets\n    t.fail('Command exited with non-zero code');\n    return;\n  }\n\n  const { stdout } = await child;\n\n  t.is(stdout, `http://${process.env.BUCKET_NAME_DEV}.s3-website-${process.env.AWS_REGION_DEV}.amazonaws.com/v2/ft-graphics-deploy/test-fixture/abcdefghijklmnop12345/`);\n});\n"]}